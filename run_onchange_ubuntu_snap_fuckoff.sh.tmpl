{{ if (eq .osid "linux-ubuntu") -}}

#!/bin/bash

# Check for root privileges
if [ "$EUID" -ne 0 ]; then
  echo "This script needs to be run with sudo."
  exit 1
fi

echo "Removing all installed snap packages..."

# List and remove all installed snap packages
snap list --all | awk '{print $1}' | grep -v "Name" | xargs -I{} sudo snap remove --purge {}

# Stop and disable snapd service
echo "Stopping and disabling snapd service..."
sudo systemctl stop snapd
sudo systemctl disable snapd
sudo systemctl mask snapd

# Remove snapd itself
echo "Uninstalling snapd..."
sudo apt purge snapd -y

# Remove any remaining snap directories
echo "Removing remaining snap directories..."
sudo rm -rf /var/cache/snapd/
rm -rf ~/snap  # No sudo needed for home directory

# Prevent snapd from being installed again by pinning it
echo "Blocking snapd from being reinstalled..."
sudo tee /etc/apt/preferences.d/no-snap.pref > /dev/null <<EOF
Package: snapd
Pin: release a=*
Pin-Priority: -10
EOF

# Confirm removal and blocking
echo "Snap packages removed, snapd uninstalled, and snapd installation blocked."

exit 0

{{ end -}}
